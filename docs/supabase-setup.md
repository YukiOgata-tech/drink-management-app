# Supabase 認証設定ガイド

このアプリでメール認証を正しく動作させるため、Supabaseダッシュボードで以下の設定を行ってください。

## 必須設定

### 1. リダイレクトURLの設定

1. [Supabaseダッシュボード](https://supabase.com/dashboard)にアクセス
2. プロジェクトを選択
3. 左サイドバーから **Authentication** をクリック
4. **URL Configuration** タブを選択
5. **Redirect URLs** セクションに以下を追加：
   ```
   drinkmanagement://*
   ```
6. 「Save」をクリック

### 2. メール認証の設定（オプション）

#### 開発環境（推奨）

開発中はメール確認を無効化することをお勧めします：

1. **Authentication** → **Providers** → **Email**
2. 「**Confirm email**」を **OFF** に設定
3. 「Save」をクリック

これにより、サインアップ直後にログインできるようになります。

#### 本番環境

本番環境では必ずメール確認を有効にしてください：

1. **Authentication** → **Providers** → **Email**
2. 「**Confirm email**」を **ON** に設定
3. 「Save」をクリック

## 動作確認

### メール認証が有効な場合

1. アプリでサインアップ
2. 登録したメールアドレスに確認メールが届く
3. メール内の「Confirm your mail」リンクをクリック
4. アプリが自動的に開き、認証が完了
5. プロフィール画面に遷移

**メールが届かない場合:**
- プロフィール画面に「メールアドレス未確認」の警告が表示されます
- 「確認メールを再送信」ボタンをタップして、メールを再送信できます

### メール認証が無効な場合

1. アプリでサインアップ
2. 即座にログイン状態になる
3. プロフィール画面に警告は表示されません

## トラブルシューティング

### メールのリンクをクリックしてもアプリが開かない

- リダイレクトURL（`drinkmanagement://*`）がSupabaseダッシュボードに正しく設定されているか確認してください
- シミュレーターを再起動してみてください
- 実機で試してみてください（シミュレーターでは動作しない場合があります）

### 「認証トークンが見つかりません」エラー

- SupabaseダッシュボードでリダイレクトURLが正しく設定されているか確認してください
- メールのリンクの有効期限が切れていないか確認してください（通常24時間）

## メール認証が有効で未確認の場合の影響

メール認証が有効になっている場合、メールアドレスを確認していないユーザーには以下の制限があります：

### 1. ログインの制限
- Supabaseの設定によっては、未確認ユーザーのログインを完全にブロック可能
- デフォルトではログイン可能ですが、`emailConfirmed`が`false`のままです

### 2. 機能の制限
- データベースのRLS（Row Level Security）ポリシーで未確認ユーザーを制限可能
- 例: グループイベントへの参加を認証済みユーザーのみに制限

### 3. セキュリティリスク
- メール認証なしでは、他人のメールアドレスで勝手にアカウント作成可能
- スパムアカウントの大量作成リスク

### 4. 通知の問題
- メールアドレスが正しいか確認できないため、重要な通知が届かない可能性

### このアプリでの対応

- プロフィール画面に「⚠️ メールアドレス未確認」の警告を表示
- 「確認メールを再送信」ボタンで簡単に再送信可能
- ゲストモードとは別に、未確認状態を明示

## URLスキーム

このアプリのカスタムURLスキーム：
- **スキーム**: `drinkmanagement://`
- **認証コールバック**: `drinkmanagement://auth/callback`

このスキームは `app.json` の `scheme` フィールドで定義されています。
